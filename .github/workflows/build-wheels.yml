name: Build Wheels

on:
  workflow_call:
    inputs:
      python-version:
        type: string
        required: true

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            arch: x86_64
            cibw_arch: x86_64
          - os: ubuntu-latest
            arch: aarch64
            cibw_arch: aarch64
          - os: windows-latest
            arch: x86_64
            cibw_arch: AMD64
          - os: windows-latest
            arch: aarch64
            cibw_arch: ARM64
          - os: macos-latest
            arch: x86_64
            cibw_arch: x86_64
          - os: macos-latest
            arch: aarch64
            cibw_arch: arm64
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - uses: ./.github/actions/build-wheels
        with:
          python-version: ${{ inputs['python-version'] }}
          cibw-arch: ${{ matrix.cibw_arch }}
          artifact-name: wheels-${{ matrix.os }}-${{ matrix.arch }}

  pure-python:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - uses: ./.github/actions/pure-python-wheel
        with:
          python-version: ${{ inputs['python-version'] }}
          artifact-name: wheels-pure

  verify-wheel-install:
    runs-on: ubuntu-latest
    needs:
      - build
      - pure-python
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: ${{ inputs['python-version'] }}
      - name: Download wheel artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          path: dist
      - name: Install pure Python wheel, then native wheel
        shell: bash
        run: |
          set -eu
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip install dist/wheels-pure/*.whl
          python -c "from cuprum import _rust_backend; print(_rust_backend.is_available())"
          PYTAG=$(python - <<'PY'
          import sys
          print(f"cp{sys.version_info.major}{sys.version_info.minor}")
          PY
          )
          python -m pip install --force-reinstall \
            dist/wheels-ubuntu-latest-x86_64/*${PYTAG}*.whl
          python -c "from cuprum import _rust_backend; print(_rust_backend.is_available())"
