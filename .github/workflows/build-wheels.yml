name: Build Wheels

on:
  workflow_call:
    inputs:
      python-version:
        type: string
        required: true

env:
  MATURIN_VERSION: "1.6.0"

jobs:
  build-pure-wheel:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - uses: ./.github/actions/pure-python-wheel
        with:
          python-version: ${{ inputs['python-version'] }}
          artifact-name: wheels-pure

  build-native-wheels:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            arch: x86_64
            target: ""
            manylinux: 2_28
          # aarch64 wheels are built via QEMU emulation under maturin-action.
          - os: ubuntu-latest
            arch: aarch64
            target: aarch64-unknown-linux-gnu
            manylinux: 2_28
          - os: macos-13
            arch: x86_64
            target: x86_64-apple-darwin
          - os: macos-latest
            arch: arm64
            target: aarch64-apple-darwin
          - os: windows-2022
            arch: x86_64
            target: x86_64-pc-windows-msvc
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - name: Build manylinux wheels (Linux x86_64)
        # Maturin action builds inside a manylinux container for PyPI tags.
        if: startsWith(matrix.os, 'ubuntu') && matrix.arch == 'x86_64'
        uses: messense/maturin-action@47fbb7acd3db01f7830330b50689bd15135c12b9
        with:
          maturin-version: ${{ env.MATURIN_VERSION }}
          target: ${{ matrix.target }}
          manylinux: ${{ matrix.manylinux }}
          command: build
          args: >-
            --release --out wheelhouse --manifest-path rust/cuprum-rust/Cargo.toml
            -i python${{ inputs.python-version }}
      - name: Set up QEMU (Linux aarch64)
        if: startsWith(matrix.os, 'ubuntu') && matrix.arch == 'aarch64'
        uses: docker/setup-qemu-action@45136fd328ae20ed788d00d3bada68ab496c214c
        with:
          platforms: arm64
      - name: Build manylinux wheels (Linux aarch64)
        # aarch64 wheels are built via QEMU with an explicit manylinux container.
        if: startsWith(matrix.os, 'ubuntu') && matrix.arch == 'aarch64'
        uses: messense/maturin-action@47fbb7acd3db01f7830330b50689bd15135c12b9
        with:
          maturin-version: ${{ env.MATURIN_VERSION }}
          target: ${{ matrix.target }}
          manylinux: ${{ matrix.manylinux }}
          container: ghcr.io/rust-cross/manylinux_2_28-cross:aarch64
          command: build
          args: >-
            --release --out wheelhouse --manifest-path rust/cuprum-rust/Cargo.toml
            -i python${{ inputs.python-version }}
      - name: Build native wheels (macOS/Windows)
        if: "!startsWith(matrix.os, 'ubuntu')"
        uses: ./.github/actions/build-wheels
        with:
          python-version: ${{ inputs['python-version'] }}
          target: ${{ matrix.target }}
          artifact-name: wheels-native-${{ matrix.os }}-${{ matrix.arch }}
          wheelhouse: wheelhouse
          maturin-version: ${{ env.MATURIN_VERSION }}
      - name: Upload wheel artifact (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: wheels-native-${{ matrix.os }}-${{ matrix.arch }}
          path: wheelhouse/*.whl

  verify-wheel-install:
    runs-on: ubuntu-latest
    needs:
      - build-pure-wheel
      - build-native-wheels
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: ${{ inputs['python-version'] }}
      - name: Download wheel artifacts
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          path: dist
      - name: Install pure Python wheel, then native wheel
        shell: bash
        env:
          NATIVE_WHEEL_DIR_PATTERN: dist/wheels-native-*
        run: |
          set -eu
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip install dist/wheels-pure/*.whl
          python - <<'PY'
          import cuprum as c
          assert c.is_rust_available() is False
          PY
          python - <<'PY'
          import importlib.metadata as im
          import json

          meta = im.metadata("cuprum")
          snapshot = {
              "name": meta.get("Name"),
              "version": meta.get("Version"),
              "requires_python": meta.get("Requires-Python"),
              "requires_dist": sorted(meta.get_all("Requires-Dist") or []),
              "classifiers": sorted(meta.get_all("Classifier") or []),
          }
          with open("/tmp/cuprum-metadata.json", "w", encoding="utf-8") as handle:
              json.dump(snapshot, handle, indent=2, sort_keys=True)
          PY
          PYTAG=$(python - <<'PY'
          import sys
          print(f"cp{sys.version_info.major}{sys.version_info.minor}")
          PY
          )
          ARCH=$(uname -m)
          shopt -s nullglob
          NATIVE_WHEEL_GLOB=(
            "${NATIVE_WHEEL_DIR_PATTERN}"/*${PYTAG}*manylinux*${ARCH}*.whl
          )
          if [ "${#NATIVE_WHEEL_GLOB[@]}" -ne 1 ]; then
            echo "Expected exactly one native wheel for ${ARCH}." >&2
            echo "Matched: ${NATIVE_WHEEL_GLOB[*]:-<none>}" >&2
            ls -al dist >&2
            exit 1
          fi
          python -m pip install --force-reinstall "${NATIVE_WHEEL_GLOB[0]}"
          python - <<'PY'
          import cuprum as c
          assert c.is_rust_available() is True
          PY
          python - <<'PY'
          import importlib.metadata as im
          import json

          with open("/tmp/cuprum-metadata.json", "r", encoding="utf-8") as handle:
              baseline = json.load(handle)

          meta = im.metadata("cuprum")
          current = {
              "name": meta.get("Name"),
              "version": meta.get("Version"),
              "requires_python": meta.get("Requires-Python"),
              "requires_dist": sorted(meta.get_all("Requires-Dist") or []),
              "classifiers": sorted(meta.get_all("Classifier") or []),
          }

          if baseline != current:
              raise SystemExit(
                  "Metadata mismatch between pure and native wheels:\n"
                  f"pure={baseline}\n"
                  f"native={current}"
              )
          PY
